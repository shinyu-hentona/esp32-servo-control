<!DOCTYPE html>
<html>
<head>
  <title>ESP32 Servo Control with Time-Based Timer</title>
  <style>
    body, html {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    #status, #timer-status {
      margin-bottom: 10px;
      font-size: 1.2em;
    }

    button {
      padding: 25px 50px; /* ボタンのパディングを増やす */
      font-size: 2.5em; /* 文字サイズを大きくする */
      margin: 20px; /* 余白を調整する */
      width: 90%; /* ボタンの幅を90%にする */
      max-width: 600px; /* 最大幅を600pxに設定 */
      border: none;
      border-radius: 10px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }

    button:active {
      background-color: #0056b3;
    }

    label, input {
      font-size: 1.2em;
      margin: 10px;
    }

    #timer-time {
      font-size: 1.5em;
      padding: 10px;
    }
  </style>
  <script>
    const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
  </script>
</head>
<body>
  <p id="status">接続ステータス: 切断</p>
  <button id="connect">接続</button>
  <button id="forward">正転</button>
  <button id="backward">逆転</button>

  <label for="timer-time">タイマー時刻を設定:</label>
  <input type="time" id="timer-time">
  <button id="setTimer">タイマーを設定</button>
  <p id="timer-status">タイマー設定: 未設定</p>

  <script>
    let bleDevice;
    let bleCharacteristic;
    let timerId = null;

    // 以前のスクリプトを省略

    document.getElementById('setTimer').addEventListener('click', function() {
      const timeValue = document.getElementById('timer-time').value;
      setTimer(timeValue);
    });

    function setTimer(timeValue) {
      if (timerId) {
        clearTimeout(timerId);
        updateTimerStatus("タイマーがキャンセルされました。");
      }

      const [hours, minutes] = timeValue.split(':').map(Number);
      const now = new Date();
      const targetTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);

      if (targetTime < now) {
        // If the target time is in the past, set it for the next day
        targetTime.setDate(targetTime.getDate() + 1);
      }

      const delay = targetTime - now;
      timerId = setTimeout(function() {
        writeBLE("forward"); // 例として正転を実行
        console.log("タイマーによりサーボが動作しました。");
        updateTimerStatus("タイマーがトリガされました。");
        timerId = null;
      }, delay);

      updateTimerStatus(`タイマーが設定されました: ${timeValue} に動作します。`);
    }

    function updateTimerStatus(status) {
      document.getElementById('timer-status').textContent = "タイマー設定: " + status;
    }

    // 以前のスクリプトを省略
  </script>
</body>
</html>
